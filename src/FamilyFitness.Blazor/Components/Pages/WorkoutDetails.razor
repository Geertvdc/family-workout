@page "/workout-details/{WorkoutSessionId:guid}"
@using System.Net.Http.Json
@using FamilyFitness.Application
@using FamilyFitness.Domain
@using FamilyFitness.Blazor.Services
@inject HttpClient Http
@inject IUserContextService UserContext
@inject NavigationManager Navigation
@rendermode InteractiveServer

<div class="container-fluid px-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="mb-1">Workout Details</h3>
            @if (workoutSession != null)
            {
                <small class="text-muted">@workoutSession.SessionDate.ToString("dddd, MMMM dd, yyyy")</small>
            }
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm" @onclick="NavigateBack">
                <i class="bi bi-arrow-left me-1"></i>
                Back
            </button>
        </div>
    </div>

    @if (errorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    @if (isLoading)
    {
        <div class="d-flex justify-content-center py-5">
            <div class="text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted">Loading workout details...</p>
            </div>
        </div>
    }
    else if (workoutSession != null)
    {
        <!-- Workout Session Overview -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Session Overview</h5>
                        <div class="mb-2">
                            <strong>Status:</strong>
                            <span class="badge @GetStatusBadgeClass(workoutSession.Status) ms-2">
                                @GetStatusText(workoutSession.Status)
                            </span>
                        </div>
                        <div class="mb-2">
                            <strong>Date:</strong> @workoutSession.SessionDate.ToString("MMMM dd, yyyy")
                        </div>
                        @if (workoutSession.StartedAt.HasValue)
                        {
                            <div class="mb-2">
                                <strong>Started:</strong> @workoutSession.StartedAt.Value.ToString("h:mm tt")
                            </div>
                        }
                        @if (workoutSession.EndedAt.HasValue)
                        {
                            <div class="mb-2">
                                <strong>Ended:</strong> @workoutSession.EndedAt.Value.ToString("h:mm tt")
                            </div>
                        }
                        @if (workoutSession.StartedAt.HasValue && workoutSession.EndedAt.HasValue)
                        {
                            <div class="mb-2">
                                <strong>Duration:</strong> @GetDurationText(workoutSession.StartedAt.Value, workoutSession.EndedAt.Value)
                            </div>
                        }
                    </div>
                    <div class="col-md-6">
                        @if (assignments?.Stations?.Any() == true)
                        {
                            <h5>Workout Stations</h5>
                            <div class="row g-2">
                                @foreach (var station in assignments.Stations.OrderBy(s => s.StationIndex))
                                {
                                    <div class="col-6">
                                        <div class="card bg-light">
                                            <div class="card-body p-2 text-center">
                                                <strong class="small">Station @station.StationIndex</strong>
                                                <div class="small">@station.WorkoutTypeName</div>
                                                @if (!string.IsNullOrEmpty(station.WorkoutTypeDescription))
                                                {
                                                    <div class="text-muted" style="font-size: 0.7rem;">@station.WorkoutTypeDescription</div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        @if (assignments?.Participants?.Any() == true && scores?.Any() == true)
        {
            <!-- Detailed Scores by Participant -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="mb-3">Detailed Scores by Participant</h5>
                    
                    @foreach (var participant in assignments.Participants.OrderBy(p => p.ParticipantIndex))
                    {
                        var participantScores = scores.Where(s => s.ParticipantId == participant.ParticipantId).ToList();
                        var totalScore = participantScores.Sum(s => s.Score);
                        
                        <div class="card mb-3">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="bi bi-person-circle me-2"></i>
                                        @participant.UserName
                                        <small class="text-muted">(Position @participant.ParticipantIndex)</small>
                                    </h6>
                                    <div>
                                        <span class="badge bg-primary">Total: @totalScore points</span>
                                    </div>
                                </div>
                            </div>
                            
                            @if (participantScores.Any())
                            {
                                <div class="card-body">
                                    <!-- Rounds and Stations Grid -->
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 80px;">Round</th>
                                                    @if (assignments?.Stations?.Any() == true)
                                                    {
                                                        @foreach (var station in assignments.Stations.OrderBy(s => s.StationIndex))
                                                        {
                                                            <th class="text-center">
                                                                Station @station.StationIndex
                                                                <br><small class="text-muted">@station.WorkoutTypeName</small>
                                                            </th>
                                                        }
                                                    }
                                                    <th class="text-center">Round Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @for (int round = 1; round <= 3; round++)
                                                {
                                                    <tr>
                                                        <td class="fw-bold">Round @round</td>
                                                        @if (assignments?.Stations?.Any() == true)
                                                        {
                                                            var roundTotal = 0;
                                                            @foreach (var station in assignments.Stations.OrderBy(s => s.StationIndex))
                                                            {
                                                                var score = participantScores.FirstOrDefault(s => s.RoundNumber == round && s.StationIndex == station.StationIndex);
                                                                roundTotal += score?.Score ?? 0;
                                                                
                                                                <td class="text-center">
                                                                    @if (score != null)
                                                                    {
                                                                        <div>
                                                                            <strong>@score.Score</strong>
                                                                            @if (score.Weight.HasValue)
                                                                            {
                                                                                <br><small class="text-muted">@score.Weight.Value lbs</small>
                                                                            }
                                                                        </div>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span class="text-muted">-</span>
                                                                    }
                                                                </td>
                                                            }
                                                            <td class="text-center fw-bold">@roundTotal</td>
                                                        }
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="card-body">
                                    <div class="text-center text-muted py-3">
                                        <i class="bi bi-info-circle me-1"></i>
                                        No scores recorded for this participant
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- Summary Statistics -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="mb-3">Summary Statistics</h5>
                    
                    <div class="row">
                        <!-- Leaderboard -->
                        <div class="col-md-6">
                            <h6>Leaderboard</h6>
                            <div class="list-group">
                                @{
                                    var leaderboard = assignments.Participants
                                        .Select(p => new {
                                            Participant = p,
                                            TotalScore = scores.Where(s => s.ParticipantId == p.ParticipantId).Sum(s => s.Score)
                                        })
                                        .OrderByDescending(x => x.TotalScore)
                                        .ToList();
                                    
                                    for (int i = 0; i < leaderboard.Count; i++)
                                    {
                                        var item = leaderboard[i];
                                        var badgeClass = i == 0 ? "bg-warning" : i == 1 ? "bg-secondary" : i == 2 ? "bg-info" : "bg-light text-dark";
                                        
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <span class="badge @badgeClass me-2">@(i + 1)</span>
                                                @item.Participant.UserName
                                            </div>
                                            <strong>@item.TotalScore points</strong>
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                        
                        <!-- Station Averages -->
                        <div class="col-md-6">
                            <h6>Average Scores by Station</h6>
                            @if (assignments?.Stations?.Any() == true)
                            {
                                <div class="list-group">
                                    @foreach (var station in assignments.Stations.OrderBy(s => s.StationIndex))
                                    {
                                        var stationScores = scores.Where(s => s.StationIndex == station.StationIndex).ToList();
                                        var average = stationScores.Any() ? stationScores.Average(s => s.Score) : 0;
                                        
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>Station @station.StationIndex</strong>
                                                <br><small class="text-muted">@station.WorkoutTypeName</small>
                                            </div>
                                            <strong>@average.ToString("F1") avg</strong>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
        else if (assignments?.Participants?.Any() != true)
        {
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-people display-1 text-muted mb-3"></i>
                    <h5 class="text-muted">No participants found</h5>
                    <p class="text-muted">This workout session doesn't have any participants.</p>
                </div>
            </div>
        }
        else if (scores?.Any() != true)
        {
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-bar-chart display-1 text-muted mb-3"></i>
                    <h5 class="text-muted">No scores recorded</h5>
                    <p class="text-muted">This workout session doesn't have any recorded scores yet.</p>
                </div>
            </div>
        }
    }
    else if (!isLoading)
    {
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="bi bi-exclamation-triangle display-1 text-muted mb-3"></i>
                <h5 class="text-muted">Workout not found</h5>
                <p class="text-muted">The requested workout session could not be found.</p>
                <button class="btn btn-primary" @onclick="NavigateBack">
                    Go Back
                </button>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public Guid WorkoutSessionId { get; set; }
    
    private WorkoutSessionDto? workoutSession;
    private SessionAssignmentDto? assignments;
    private List<WorkoutIntervalScoreDto>? scores;
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadWorkoutDetails();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (WorkoutSessionId != Guid.Empty)
        {
            await LoadWorkoutDetails();
        }
    }

    private async Task LoadWorkoutDetails()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            // Load workout session details
            workoutSession = await Http.GetFromJsonAsync<WorkoutSessionDto>($"/api/workout-sessions/{WorkoutSessionId}");

            // Load assignments (participants and stations)
            assignments = await Http.GetFromJsonAsync<SessionAssignmentDto>($"/api/workout-sessions/{WorkoutSessionId}/assignments");

            // Load scores for this session
            scores = await Http.GetFromJsonAsync<List<WorkoutIntervalScoreDto>>($"/api/workout-interval-scores?workoutSessionId={WorkoutSessionId}");

            if (workoutSession == null)
            {
                errorMessage = "Workout session not found.";
            }
        }
        catch (HttpRequestException ex) when (ex.Message.Contains("404"))
        {
            errorMessage = "Workout session not found.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load workout details: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void NavigateBack()
    {
        Navigation.NavigateTo("/");
    }

    private static string GetStatusBadgeClass(WorkoutSessionStatus status)
    {
        return status switch
        {
            WorkoutSessionStatus.Completed => "bg-success",
            WorkoutSessionStatus.Active => "bg-primary",
            WorkoutSessionStatus.Cancelled => "bg-danger",
            WorkoutSessionStatus.Pending => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    private static string GetStatusText(WorkoutSessionStatus status)
    {
        return status switch
        {
            WorkoutSessionStatus.Completed => "Completed",
            WorkoutSessionStatus.Active => "Active",
            WorkoutSessionStatus.Cancelled => "Cancelled",
            WorkoutSessionStatus.Pending => "Pending",
            _ => status.ToString()
        };
    }

    private static string GetDurationText(DateTime startedAt, DateTime endedAt)
    {
        var duration = endedAt - startedAt;
        if (duration.TotalMinutes < 1)
        {
            return $"{Math.Max(0, (int)duration.TotalSeconds)}s";
        }

        if (duration.TotalHours < 1)
        {
            return $"{(int)duration.TotalMinutes}m";
        }

        return $"{(int)duration.TotalHours}h {(int)duration.Minutes}m";
    }
}

<style>
    .table th {
        font-size: 0.85rem;
        padding: 0.5rem 0.25rem;
    }
    
    .table td {
        padding: 0.5rem 0.25rem;
        vertical-align: middle;
    }
    
    .card-header h6 {
        font-size: 1rem;
    }
    
    .list-group-item {
        font-size: 0.9rem;
    }
</style>