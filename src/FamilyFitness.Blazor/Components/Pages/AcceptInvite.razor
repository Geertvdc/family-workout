@page "/invite/{Token}"
@using System.Net.Http.Json
@inject HttpClient Http
@inject NavigationManager Navigation
@rendermode InteractiveServer

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-6">
            @if (isLoading)
            {
                <div class="card">
                    <div class="card-body text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Loading invite details...</p>
                    </div>
                </div>
            }
            else if (errorMessage != null)
            {
                <div class="card border-danger">
                    <div class="card-header bg-danger text-white">
                        <strong>Invalid Invite</strong>
                    </div>
                    <div class="card-body">
                        <p class="card-text">@errorMessage</p>
                        <a href="/groups" class="btn btn-primary">Go to My Groups</a>
                    </div>
                </div>
            }
            else if (acceptedSuccessfully)
            {
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <strong>Welcome to the Group!</strong>
                    </div>
                    <div class="card-body text-center">
                        <h4 class="card-title">@acceptedGroupName</h4>
                        <p class="card-text text-success">
                            You have successfully joined this group!
                        </p>
                        <a href="/groups" class="btn btn-success btn-lg mt-3">Go to My Groups</a>
                    </div>
                </div>
            }
            else if (invite != null)
            {
                <div class="card">
                    <div class="card-header">
                        <strong>Group Invitation</strong>
                    </div>
                    <div class="card-body text-center">
                        <h3 class="card-title mb-4">@invite.GroupName</h3>
                        <p class="card-text text-muted">
                            You've been invited to join this group.
                        </p>
                        <p class="small text-muted">
                            Invite created: @invite.CreatedAt.ToString("MMMM dd, yyyy")
                        </p>
                        
                        <hr />
                        
                        <button class="btn btn-primary btn-lg" @onclick="AcceptInviteAsync" disabled="@isAccepting">
                            @if (isAccepting)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <span>Joining...</span>
                            }
                            else
                            {
                                <span>Accept Invite & Join Group</span>
                            }
                        </button>
                        
                        <div class="mt-3">
                            <a href="/groups" class="btn btn-link text-muted">Cancel</a>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public string Token { get; set; } = string.Empty;

    private GroupInviteDto? invite;
    private bool isLoading = true;
    private bool isAccepting = false;
    private bool acceptedSuccessfully = false;
    private string? acceptedGroupName;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadInviteDetails();
    }

    private async Task LoadInviteDetails()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var response = await Http.GetAsync($"/api/invites/{Token}");
            
            if (response.IsSuccessStatusCode)
            {
                invite = await response.Content.ReadFromJsonAsync<GroupInviteDto>();
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                errorMessage = "This invite link is invalid or has been revoked.";
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                // User needs to log in - redirect to login
                Navigation.NavigateTo("/", forceLoad: true);
                return;
            }
            else
            {
                var error = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                errorMessage = error?.error ?? "Failed to load invite details.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading invite: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task AcceptInviteAsync()
    {
        if (invite == null) return;

        try
        {
            isAccepting = true;
            errorMessage = null;

            var response = await Http.PostAsync($"/api/invites/{Token}/accept", null);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<AcceptInviteResult>();
                if (result?.Success == true)
                {
                    acceptedSuccessfully = true;
                    acceptedGroupName = result.Group?.Name ?? invite.GroupName;
                }
                else
                {
                    errorMessage = result?.ErrorMessage ?? "Failed to accept invite.";
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.BadRequest)
            {
                var error = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                errorMessage = error?.error ?? "Could not accept this invite.";
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                Navigation.NavigateTo("/", forceLoad: true);
                return;
            }
            else
            {
                var error = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                errorMessage = error?.error ?? "Failed to accept invite.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isAccepting = false;
        }
    }

    public class GroupInviteDto
    {
        public Guid Id { get; set; }
        public Guid GroupId { get; set; }
        public string GroupName { get; set; } = string.Empty;
        public string Token { get; set; } = string.Empty;
        public DateTime CreatedAt { get; set; }
        public bool IsActive { get; set; }
    }

    public class AcceptInviteResult
    {
        public bool Success { get; set; }
        public string? ErrorMessage { get; set; }
        public GroupDto? Group { get; set; }
    }

    public class GroupDto
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
    }

    public class ErrorResponse
    {
        public string error { get; set; } = string.Empty;
    }
}
