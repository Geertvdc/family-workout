@page "/home"
@attribute [Authorize]
@using System.Net.Http.Json
@using FamilyFitness.Blazor.Models
@using Microsoft.AspNetCore.Authorization
@inject HttpClient Http
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>FFWOD - Home</PageTitle>

<div class="home-container">
    <h1>FFWOD</h1>
    <p class="tagline">Workout of the Day</p>

    @if (error != null)
    {
        <div class="alert alert-danger">
            @error
            @if (error.Contains("401") || error.Contains("Unauthorized"))
            {
                <div class="mt-2">
                    <p><strong>Authentication issue detected.</strong> This usually means you need to grant API access permissions.</p>
                    <a href="/consent" class="btn btn-warning btn-sm">Grant API Access</a>
                </div>
            }
        </div>
    }

    @if (loading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (activeSession != null)
    {
        <div class="card card-active">
            <div class="card-body">
                <div class="active-badge">ACTIVE WORKOUT</div>
                <h2>Workout in Progress</h2>
                <p>You have an active workout in progress!</p>
                <button class="btn btn-primary btn-lg btn-block" @onclick="ResumeWorkout">Resume Workout</button>
                <button class="btn btn-secondary mt-2" @onclick="CancelActiveSession">Cancel Session</button>
            </div>
        </div>
    }
    else
    {
        <div class="card mt-4">
            <div class="card-body">
                <h2>Start a New Workout</h2>
                <p>Ready to push your limits?</p>
                <a href="/setup-wod" class="btn btn-primary btn-lg btn-block">Start New Workout</a>
            </div>
        </div>
    }
</div>

@code {
    private SessionDto? activeSession;
    private bool loading = true;
    private string? error;

    // Hardcoded group ID for MVP - in production this would come from user context (matches seeded data)
    private readonly Guid defaultGroupId = Guid.Parse("aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa");

    protected override async Task OnInitializedAsync()
    {
        await LoadActiveSession();
    }

    private async Task LoadActiveSession()
    {
        loading = true;
        error = null;

        try
        {
            var response = await Http.GetAsync($"/api/groups/{defaultGroupId}/active-session");
            if (response.IsSuccessStatusCode)
            {
                activeSession = await response.Content.ReadFromJsonAsync<SessionDto>();
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                error = "Failed to load data: Response status code does not indicate success: 401 (Unauthorized).";
            }
        }
        catch (Exception ex)
        {
            if (ex.Message.Contains("401") || ex.Message.Contains("Unauthorized"))
            {
                error = "Failed to load data: Response status code does not indicate success: 401 (Unauthorized).";
            }
            else
            {
                // No active session or other error - that's okay for home page
                activeSession = null;
            }
        }
        finally
        {
            loading = false;
        }
    }

    private void ResumeWorkout()
    {
        if (activeSession != null)
        {
            Navigation.NavigateTo($"/run-wod/{activeSession.Id}");
        }
    }

    private async Task CancelActiveSession()
    {
        if (activeSession == null) return;

        try
        {
            var response = await Http.PostAsync($"/api/workout-sessions/{activeSession.Id}/cancel", null);
            if (response.IsSuccessStatusCode)
            {
                activeSession = null;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            error = $"Failed to cancel session: {ex.Message}";
        }
    }
}

