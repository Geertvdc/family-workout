@page "/"
@using System.Net.Http.Json
@using FamilyFitness.Blazor.Models
@inject HttpClient Http
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Home</PageTitle>

<div class="home-container">
    <h1>Family Fitness</h1>

    @if (error != null)
    {
        <div class="alert alert-danger">@error</div>
    }

    @if (loading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (activeSession != null)
    {
        <div class="card mt-4">
            <div class="card-body">
                <h2>Active Workout</h2>
                <p>You have an active workout in progress!</p>
                <button class="btn btn-success btn-lg" @onclick="ResumeWorkout">Resume Workout</button>
                <button class="btn btn-secondary ms-2" @onclick="CancelActiveSession">Cancel Session</button>
            </div>
        </div>
    }
    else
    {
        <div class="card mt-4">
            <div class="card-body">
                <h2>Start a New Workout</h2>
                <p>Ready to get started? Setup your workout below.</p>
                <a href="/setup-wod" class="btn btn-primary btn-lg">Start New Workout</a>
            </div>
        </div>
    }
</div>

@code {
    private SessionDto? activeSession;
    private bool loading = true;
    private string? error;

    // Hardcoded group ID for MVP - in production this would come from user context
    private readonly Guid defaultGroupId = Guid.Parse("00000000-0000-0000-0000-000000000001");

    protected override async Task OnInitializedAsync()
    {
        await LoadActiveSession();
    }

    private async Task LoadActiveSession()
    {
        loading = true;
        error = null;

        try
        {
            var response = await Http.GetAsync($"/api/groups/{defaultGroupId}/active-session");
            if (response.IsSuccessStatusCode)
            {
                activeSession = await response.Content.ReadFromJsonAsync<SessionDto>();
            }
        }
        catch (Exception)
        {
            // No active session or error - that's okay
            activeSession = null;
        }
        finally
        {
            loading = false;
        }
    }

    private void ResumeWorkout()
    {
        if (activeSession != null)
        {
            Navigation.NavigateTo($"/run-wod/{activeSession.Id}");
        }
    }

    private async Task CancelActiveSession()
    {
        if (activeSession == null) return;

        try
        {
            var response = await Http.PostAsync($"/api/workout-sessions/{activeSession.Id}/cancel", null);
            if (response.IsSuccessStatusCode)
            {
                activeSession = null;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            error = $"Failed to cancel session: {ex.Message}";
        }
    }
}

