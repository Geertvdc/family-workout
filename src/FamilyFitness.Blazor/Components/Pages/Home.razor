@page "/home"
@attribute [Authorize]
@using System.Net.Http.Json
@using FamilyFitness.Application
@using FamilyFitness.Blazor.Services
@using Microsoft.AspNetCore.Authorization
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IUserContextService UserContext
@rendermode InteractiveServer

<PageTitle>FFWOD - Home</PageTitle>

<div class="home-container">
    <h1>FFWOD</h1>
    <p class="tagline">Workout of the Day</p>

    @if (error != null)
    {
        <div class="alert alert-danger">
            @error
            @if (error.Contains("401") || error.Contains("Unauthorized"))
            {
                <div class="mt-2">
                    <p><strong>Authentication issue detected.</strong> This usually means you need to grant API access permissions.</p>
                    <a href="/consent" class="btn btn-warning btn-sm">Grant API Access</a>
                </div>
            }
        </div>
    }

    @if (loading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        <!-- Group Selector -->
        <GroupSelector SelectedGroupId="@selectedGroupId" 
                       SelectedGroupIdChanged="@OnGroupChanged"
                       OnGroupSelected="@OnGroupSelected" />

        @if (selectedGroupId.HasValue)
        {
            @if (activeSession != null)
            {
                <div class="card card-active">
                    <div class="card-body">
                        <div class="active-badge">ACTIVE WORKOUT</div>
                        <h2>Workout in Progress</h2>
                        <p>You have an active workout in progress in <strong>@selectedGroupName</strong>!</p>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-lg" @onclick="ResumeWorkout">Resume Workout</button>
                            <div class="d-flex gap-2">
                                <button class="btn btn-secondary flex-fill" @onclick="CancelActiveSession">Cancel Session</button>
                                <a href="/workout-history/@selectedGroupId" class="btn btn-outline-secondary flex-fill">
                                    <i class="bi bi-clock-history me-1"></i>History
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="card mt-4">
                    <div class="card-body">
                        <h2>Start a New Workout</h2>
                        <p>Ready to push your limits with <strong>@selectedGroupName</strong>?</p>
                        <div class="d-grid gap-2">
                            <a href="/setup-wod" class="btn btn-primary btn-lg">Start New Workout</a>
                            <a href="/workout-history/@selectedGroupId" class="btn btn-outline-primary">
                                <i class="bi bi-clock-history me-1"></i>View Workout History
                            </a>
                        </div>
                    </div>
                </div>
            }
        }
        else if (hasGroups)
        {
            <div class="card mt-4">
                <div class="card-body">
                    <h2>Select a Group</h2>
                    <p>Please select a group to start a workout.</p>
                </div>
            </div>
        }
    }
</div>

@code {
    private WorkoutSessionDto? activeSession;
    private bool loading = true;
    private string? error;
    private Guid? selectedGroupId;
    private string selectedGroupName = "";
    private bool hasGroups = false;

    protected override async Task OnInitializedAsync()
    {
        // Load user's groups to determine if they have any
        var userGroups = await UserContext.GetUserGroupsAsync();
        hasGroups = userGroups.Any();
        
        // Set initial group selection if user has groups
        if (hasGroups)
        {
            var sessionGroupId = UserContext.GetSessionGroupId();
            if (sessionGroupId.HasValue)
            {
                selectedGroupId = sessionGroupId;
                await LoadActiveSessionForGroup(selectedGroupId.Value);
            }
        }
        
        loading = false;
    }

    private async Task OnGroupChanged(Guid? newGroupId)
    {
        selectedGroupId = newGroupId;
        activeSession = null;
        error = null;

        if (newGroupId.HasValue)
        {
            await LoadActiveSessionForGroup(newGroupId.Value);
        }
        
        StateHasChanged();
    }

    private async Task OnGroupSelected(GroupDto? group)
    {
        selectedGroupName = group?.Name ?? "";
        StateHasChanged();
    }

    private async Task LoadActiveSessionForGroup(Guid groupId)
    {
        try
        {
            var response = await Http.GetAsync($"/api/groups/{groupId}/active-session");
            if (response.IsSuccessStatusCode)
            {
                activeSession = await response.Content.ReadFromJsonAsync<WorkoutSessionDto>();
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                error = "Failed to load data: Response status code does not indicate success: 401 (Unauthorized).";
            }
        }
        catch (Exception ex)
        {
            if (ex.Message.Contains("401") || ex.Message.Contains("Unauthorized"))
            {
                error = "Failed to load data: Response status code does not indicate success: 401 (Unauthorized).";
            }
            else
            {
                // No active session or other error - that's okay for home page
                activeSession = null;
            }
        }
    }

    private void ResumeWorkout()
    {
        if (activeSession != null)
        {
            Navigation.NavigateTo($"/run-wod/{activeSession.Id}");
        }
    }

    private async Task CancelActiveSession()
    {
        if (activeSession == null) return;

        try
        {
            var response = await Http.PostAsync($"/api/workout-sessions/{activeSession.Id}/cancel", null);
            if (response.IsSuccessStatusCode)
            {
                activeSession = null;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            error = $"Failed to cancel session: {ex.Message}";
        }
    }
}

