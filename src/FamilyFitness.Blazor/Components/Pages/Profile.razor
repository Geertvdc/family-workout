@page "/profile"
@attribute [Authorize]
@using System.Net.Http.Json
@using FamilyFitness.Application
@using FamilyFitness.Blazor.Models
@using FamilyFitness.Blazor.Services
@using Microsoft.AspNetCore.Authorization
@inject HttpClient Http
@inject IUserContextService UserContext
@rendermode InteractiveServer

<PageTitle>FFWOD - Profile</PageTitle>

<div class="container-fluid px-3" style="max-width: 720px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">Profile</h3>
        <NavLink href="/" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-house me-1"></i>
            Home
        </NavLink>
    </div>

    @if (errorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    @if (successMessage != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
        </div>
    }

    @if (isLoading)
    {
        <div class="d-flex justify-content-center py-5">
            <div class="text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted">Loading profile...</p>
            </div>
        </div>
    }
    else if (currentUser == null)
    {
        <div class="alert alert-warning">
            Could not load your profile. Please try again.
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-body">
                <EditForm Model="editModel" OnValidSubmit="SaveAsync">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input class="form-control" value="@currentUser.Email" disabled />
                        <div class="form-text">Email is managed by your sign-in provider.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <InputText class="form-control" @bind-Value="editModel.Username" />
                        <div class="form-text">Shown to other members in your groups.</div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <span>Saving...</span>
                            }
                            else
                            {
                                <span>Save</span>
                            }
                        </button>
                        <button type="button" class="btn btn-outline-secondary" @onclick="Reset">
                            Reset
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    }
</div>

@code {
    private FamilyFitness.Application.UserDto? currentUser;
    private bool isLoading = true;
    private bool isSaving;
    private string? errorMessage;
    private string? successMessage;

    private EditProfileModel editModel = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        try
        {
            errorMessage = null;
            currentUser = await UserContext.GetCurrentUserAsync();

            if (currentUser != null)
            {
                editModel = new EditProfileModel
                {
                    Username = currentUser.Username
                };
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load profile: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SaveAsync()
    {
        if (currentUser == null)
        {
            return;
        }

        try
        {
            isSaving = true;
            errorMessage = null;
            successMessage = null;

            var command = new
            {
                Id = currentUser.Id,
                Username = editModel.Username?.Trim() ?? string.Empty,
                Email = currentUser.Email
            };

            var response = await Http.PutAsJsonAsync($"/api/users/{currentUser.Id}", command);
            if (!response.IsSuccessStatusCode)
            {
                var error = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                errorMessage = error?.error ?? "Failed to save profile";
                return;
            }

            // Refresh cached user so navigation/UI shows new name.
            UserContext.ClearCache();
            currentUser = await UserContext.GetCurrentUserAsync();

            successMessage = "Profile updated.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to save profile: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void Reset()
    {
        errorMessage = null;
        successMessage = null;

        if (currentUser != null)
        {
            editModel = new EditProfileModel
            {
                Username = currentUser.Username
            };
        }
    }

    private sealed class EditProfileModel
    {
        public string Username { get; set; } = string.Empty;
    }
}
