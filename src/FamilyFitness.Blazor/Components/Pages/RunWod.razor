@page "/run-wod/{sessionId:guid}"
@using System.Net.Http.Json
@using FamilyFitness.Blazor.Models
@using FamilyFitness.Blazor.Components
@using Microsoft.JSInterop
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>FFWOD - Workout</PageTitle>

<div class="wod-container">
    @if (error != null)
    {
        <div class="alert alert-danger">@error</div>
    }

    @if (session == null || assignments == null)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (session.Status == WorkoutSessionStatus.Completed)
    {
        <div class="completion-screen">
            <h1>ðŸ”¥ WORKOUT COMPLETE! ðŸ”¥</h1>
            <p class="completion-subtitle">GREAT JOB!</p>
            <button class="btn btn-primary btn-lg" @onclick="GoHome">Back to Dashboard</button>
        </div>
    }
    else if (session.Status == WorkoutSessionStatus.Cancelled)
    {
        <div class="completion-screen">
            <h1>WORKOUT CANCELLED</h1>
            <button class="btn btn-primary btn-lg" @onclick="GoHome">Back to Dashboard</button>
        </div>
    }
    else
    {
        @if (currentPhase == TimerPhase.Ready || currentPhase == TimerPhase.Work)
        {
            <div class="wod-live-layout">
                <div class="wod-live-timer">
                    <WodTimer 
                        CurrentPhase="@currentPhase"
                        TimeRemaining="@timeRemaining"
                        CurrentRound="@currentRound"
                        CurrentStation="@currentStation"
                        OnPhaseComplete="@HandlePhaseComplete" />
                </div>
                <div class="wod-live-assignments">
                    <StationAssignments 
                        Participants="@assignments.Participants"
                        Stations="@assignments.Stations"
                        CurrentRound="@currentRound"
                        CurrentStation="@currentStation"
                        Title="@(currentPhase == TimerPhase.Ready ? "Get Ready!" : "Current Stations")" />
                    
                    <div class="workout-controls">
                        <button class="btn btn-danger" @onclick="ShowCancelConfirmation">CANCEL WORKOUT</button>
                    </div>
                </div>
            </div>
        }
        else if (currentPhase == TimerPhase.Cooldown)
        {
            <WodTimer 
                CurrentPhase="@currentPhase"
                TimeRemaining="@timeRemaining"
                CurrentRound="@currentRound"
                CurrentStation="@currentStation"
                CompactMode="true"
                OnPhaseComplete="@HandlePhaseComplete" />

            <div class="cooldown-container">
                <h3>Score Entry - Round @currentRound</h3>
                
                <ScoreEntry @ref="scoreEntryRef"
                    SessionId="@SessionId"
                    Participants="@assignments.Participants"
                    Stations="@assignments.Stations"
                    CurrentRound="@currentRound"
                    CurrentStation="@currentStation"
                    OnScoresSaved="@HandleScoresSaved"
                    OnSavingStateChanged="@HandleSavingStateChanged" />

                <div class="next-preview-compact">
                    <h4>NEXT UP</h4>
                    <div class="next-assignments-boxes">
                        @if (assignments.Participants != null && assignments.Stations != null)
                        {
                            @foreach (var participant in assignments.Participants.OrderBy(p => p.ParticipantIndex))
                            {
                                var nextStation = GetNextStationForParticipant(participant);
                                if (nextStation != null)
                                {
                                    <div class="next-assignment-box">
                                        <div class="next-participant">@participant.UserName</div>
                                        <div class="next-exercise">@nextStation.WorkoutTypeName</div>
                                    </div>
                                }
                            }
                        }
                    </div>
                </div>

                <div class="cooldown-actions mt-4">
                    <button class="btn btn-outline-secondary" @onclick="ShowCancelConfirmation">CANCEL</button>
                    <button class="btn btn-success btn-lg" 
                            @onclick="HandleSaveAndNextStation"
                            disabled="@(!cooldownComplete || savingScores)">
                        @(savingScores ? "SAVING..." : "NEXT STATION")
                    </button>
                </div>
            </div>
        }
    }
</div>

@if (showCancelDialog)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cancel Workout?</h5>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to cancel this workout? All missing scores will be set to 0.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showCancelDialog = false">No, Continue</button>
                    <button type="button" class="btn btn-danger" @onclick="CancelWorkout">Yes, Cancel</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop show"></div>
}

@code {
    [Parameter]
    public Guid SessionId { get; set; }

    // WOD Configuration Constants
    private const int ReadyCountdownSeconds = 5;
    private const int WorkIntervalSeconds = 60;
    private const int CooldownMinimumSeconds = 15;
    private const int TotalRounds = 3;
    private const int StationsPerRound = 4;

    private WorkoutSessionDto? session;
    private SessionAssignmentDto? assignments;
    private string? error;
    private bool showCancelDialog = false;

    // Timer state
    private TimerPhase currentPhase = TimerPhase.Ready;
    private int timeRemaining = ReadyCountdownSeconds;
    private int currentRound = 1;
    private int currentStation = 1;
    private bool cooldownComplete = false;
    private bool scoresEntered = false;
    private bool savingScores = false;
    private System.Threading.Timer? timer;
    private ScoreEntry? scoreEntryRef;

    protected override async Task OnInitializedAsync()
    {
        await LoadSessionData();
    }

    private async Task LoadSessionData()
    {
        try
        {
            session = await Http.GetFromJsonAsync<WorkoutSessionDto>($"/api/workout-sessions/{SessionId}");
            assignments = await Http.GetFromJsonAsync<SessionAssignmentDto>($"/api/workout-sessions/{SessionId}/assignments");

            if (session?.Status == WorkoutSessionStatus.Pending)
            {
                // Start the session
                var response = await Http.PostAsync($"/api/workout-sessions/{SessionId}/start", null);
                if (response.IsSuccessStatusCode)
                {
                    session = await response.Content.ReadFromJsonAsync<WorkoutSessionDto>();
                    StartTimer();
                }
            }
            else if (session?.Status == WorkoutSessionStatus.Active)
            {
                // Resume from where we left off
                StartTimer();
            }
        }
        catch (Exception ex)
        {
            error = $"Failed to load session: {ex.Message}";
        }
    }

    private void StartTimer()
    {
        timer?.Dispose();
        timer = new System.Threading.Timer(async _ => await TimerTick(), null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
    }

    private async Task TimerTick()
    {
        await InvokeAsync(() =>
        {
            timeRemaining--;

            if (timeRemaining <= 0)
            {
                // Move to next phase
                if (currentPhase == TimerPhase.Ready)
                {
                    currentPhase = TimerPhase.Work;
                    timeRemaining = WorkIntervalSeconds;
                }
                else if (currentPhase == TimerPhase.Work)
                {
                    currentPhase = TimerPhase.Cooldown;
                    timeRemaining = CooldownMinimumSeconds;
                    cooldownComplete = false;
                    scoresEntered = false;
                }
                else if (currentPhase == TimerPhase.Cooldown)
                {
                    cooldownComplete = true;
                }
            }

            StateHasChanged();
        });
    }

    private void HandlePhaseComplete()
    {
        // Phase completion is handled by timer
    }

    private async Task HandleNextStation()
    {
        if (!cooldownComplete || !scoresEntered)
            return;

        // Advance to next station/round
        currentStation++;
        if (currentStation > StationsPerRound)
        {
            currentStation = 1;
            currentRound++;
            
            if (currentRound > TotalRounds)
            {
                // Workout complete
                await CompleteWorkout();
                return;
            }
        }

        // Start next interval
        currentPhase = TimerPhase.Ready;
        timeRemaining = ReadyCountdownSeconds;
    }

    private void HandleScoresSaved()
    {
        scoresEntered = true;
        StateHasChanged();
    }

    private void HandleSavingStateChanged(bool isSaving)
    {
        savingScores = isSaving;
        StateHasChanged();
    }

    private async Task HandleSaveAndNextStation()
    {
        if (!cooldownComplete || scoreEntryRef == null)
            return;

        // Save scores first
        await scoreEntryRef.SaveScoresExternal();
        
        // If saving was successful, move to next station
        if (scoresEntered)
        {
            await HandleNextStation();
        }
    }

    private async Task CompleteWorkout()
    {
        try
        {
            timer?.Dispose();
            var response = await Http.PostAsync($"/api/workout-sessions/{SessionId}/complete", null);
            if (response.IsSuccessStatusCode)
            {
                session = await response.Content.ReadFromJsonAsync<WorkoutSessionDto>();
                
                // Trigger confetti celebration
                try
                {
                    await JS.InvokeVoidAsync("confetti", new
                    {
                        particleCount = 150,
                        spread = 70,
                        origin = new { y = 0.6 },
                        colors = new[] { "#E63946", "#FFFFFF", "#000000" }
                    });
                }
                catch
                {
                    // Confetti failed but that's okay
                }
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            error = $"Failed to complete workout: {ex.Message}";
        }
    }

    private void ShowCancelConfirmation()
    {
        showCancelDialog = true;
    }

    private async Task CancelWorkout()
    {
        try
        {
            timer?.Dispose();
            var response = await Http.PostAsync($"/api/workout-sessions/{SessionId}/cancel", null);
            if (response.IsSuccessStatusCode)
            {
                session = await response.Content.ReadFromJsonAsync<WorkoutSessionDto>();
                showCancelDialog = false;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            error = $"Failed to cancel workout: {ex.Message}";
            showCancelDialog = false;
        }
    }

    private void GoHome()
    {
        Navigation.NavigateTo("/");
    }

    private StationDto? GetNextStationForParticipant(ParticipantDto participant)
    {
        if (assignments?.Stations == null || assignments?.Participants == null) return null;

        var participantCount = assignments.Participants.Count;
        var stationCount = assignments.Stations.Count;

        // Calculate next station (same logic as StationAssignments but for next interval)
        var baseStationIndex = ((participant.ParticipantIndex - 1) % stationCount) + 1;
        var nextIntervalsCompleted = ((currentRound - 1) * stationCount) + currentStation; // +1 from current
        var nextStationIndex = ((baseStationIndex - 1 + nextIntervalsCompleted) % stationCount) + 1;

        return assignments.Stations.FirstOrDefault(s => s.StationIndex == nextStationIndex);
    }

    public void Dispose()
    {
        timer?.Dispose();
    }
}
