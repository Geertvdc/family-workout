@page "/"
@using Microsoft.AspNetCore.Components.Authorization
@using FamilyFitness.Application
@using FamilyFitness.Blazor.Services
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@inject IUserContextService UserContext
@rendermode InteractiveServer

<PageTitle>FFWOD - Family Fitness Workout of the Day</PageTitle>

<div class="welcome-container">
    <div class="hero-section">
        <h1 class="display-1">FFWOD</h1>
        <p class="lead">Family Fitness Workout of the Day</p>
        <p class="fs-5">Get fit together as a family with daily workouts, progress tracking, and friendly competition!</p>
    </div>

    <AuthorizeView>
        <Authorized>
            @if (loadingUserGroups)
            {
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Setting up your workspace...</p>
                </div>
            }
            else if (userGroups?.Any() == true)
            {
                <!-- User has groups - show dashboard option -->
                <div class="card">
                    <div class="card-body text-center">
                        <h3>Welcome back!</h3>
                        <p>Ready to continue your fitness journey?</p>
                        <a href="/home" class="btn btn-primary btn-lg">Go to Dashboard</a>
                    </div>
                </div>
            }
            else
            {
                <!-- User has no groups - show onboarding -->
                <div class="card">
                    <div class="card-body text-center">
                        <h3>Welcome to FFWOD! üéâ</h3>
                        <p class="text-muted mb-4">Let's get you started with your first workout group.</p>
                        
                        <div class="get-started-steps">
                            <div class="step">
                                <div class="step-number">1</div>
                                <h6>Create Your Group</h6>
                                <p class="small">Set up a workout group for your family or friends</p>
                            </div>
                            
                            <div class="step">
                                <div class="step-number">2</div>
                                <h6>Invite Members</h6>
                                <p class="small">Share an invite link to add people to your group</p>
                            </div>
                            
                            <div class="step">
                                <div class="step-number">3</div>
                                <h6>Start Working Out</h6>
                                <p class="small">Create and run workouts together!</p>
                            </div>
                        </div>
                        
                        <div class="welcome-actions mt-4">
                            <a href="/groups" class="btn btn-primary btn-lg">
                                üèÉ‚Äç‚ôÄÔ∏è Create or Join a Group
                            </a>
                        </div>
                    </div>
                </div>
            }
        </Authorized>
        <NotAuthorized>
            <div class="info-section mt-4">
                <div class="alert alert-info">
                    <h5>üëã First time here?</h5>
                    <p class="mb-2">When you click "Get Started", you'll be taken to our secure authentication page.</p>
                    <ul class="mb-0 text-start">
                        <li><strong>New users:</strong> Look for "Create account", "Sign up now", or similar link</li>
                        <li><strong>Existing users:</strong> Simply enter your credentials to sign in</li>
                        <li><strong>Need API access?</strong> <a href="/consent">Click here to grant permissions</a></li>
                    </ul>
                </div>
            </div>

            <div class="row g-4 mt-4">
                <div class="col-12">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <h3>Ready to Get Started?</h3>
                            <p>Click below to sign in with your existing account or create a new one.</p>
                            <p><small class="text-muted">Both new and existing users use the same secure authentication page.</small></p>
                            <a href="/signin" class="btn btn-success btn-lg">Sign In / Sign Up</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="features-section mt-5">
                <h2 class="text-center mb-4">Why Choose FFWOD?</h2>
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="text-center">
                            <h4>Daily Workouts</h4>
                            <p>Fresh, engaging workouts designed for the whole family.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h4>Track Progress</h4>
                            <p>Monitor your fitness journey with detailed statistics and insights.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h4>Family Fun</h4>
                            <p>Compete with family members and celebrate achievements together.</p>
                        </div>
                    </div>
                </div>
            </div>
        </NotAuthorized>
    </AuthorizeView>
</div>

@code {
    private bool loadingUserGroups = true;
    private List<GroupDto>? userGroups;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            if (authState.User.Identity?.IsAuthenticated == true)
            {
                // Load user groups to determine the appropriate experience
                try
                {
                    userGroups = await UserContext.GetUserGroupsAsync();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error loading user groups: {ex.Message}");
                    userGroups = new List<GroupDto>();
                }
                
                loadingUserGroups = false;
                StateHasChanged();
            }
        }
    }
}

<style>
    .welcome-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem;
    }

    .hero-section {
        text-align: center;
        margin-bottom: 3rem;
    }

    .features-section {
        margin-top: 4rem;
    }

    .card {
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
    }

    .card:hover {
        transform: translateY(-2px);
    }

    .btn-lg {
        padding: 0.75rem 2rem;
        font-size: 1.1rem;
    }

    .get-started-steps {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin: 2rem 0;
        flex-wrap: wrap;
    }

    .step {
        flex: 1;
        min-width: 150px;
        max-width: 200px;
        text-align: center;
    }

    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--color-red-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.5rem;
        font-weight: bold;
        font-size: 1.1rem;
    }

    .step h6 {
        color: var(--color-red-primary);
        margin-bottom: 0.5rem;
    }

    .step p.small {
        color: var(--bs-gray-600);
        margin-bottom: 0;
    }

    @@media (max-width: 768px) {
        .get-started-steps {
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .welcome-actions .btn {
            display: block;
            margin: 0.5rem auto;
            max-width: 300px;
            width: 100%;
        }
    }
</style>