@page "/setup-wod"
@using System.Net.Http.Json
@using FamilyFitness.Application
@using FamilyFitness.Blazor.Components
@using FamilyFitness.Blazor.Services
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IUserContextService UserContext
@rendermode InteractiveServer

<PageTitle>FFWOD - Setup Workout</PageTitle>

<div class="setup-container">
    <h1>Setup Workout</h1>

    @if (error != null)
    {
        <div class="alert alert-danger">@error</div>
    }

    @if (loading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (currentUser == null)
    {
        <div class="alert alert-warning">
            <h4>Authentication Required</h4>
            <p>Please log in to create workouts.</p>
        </div>
    }
    else if (selectedGroupId == null)
    {
        <div class="card mb-4">
            <div class="card-body">
                <h2>Select a Group</h2>
                <p class="text-muted">Pick which group this workout belongs to.</p>

                <GroupSelector SelectedGroupId="@selectedGroupId"
                               SelectedGroupIdChanged="@OnGroupChanged"
                               OnGroupSelected="@OnGroupSelected" />

                <div class="mt-4">
                    <NavLink href="/" class="btn btn-outline-secondary btn-lg">
                        ‚Üê Back to Dashboard
                    </NavLink>
                </div>
            </div>
        </div>
    }
    else if (currentStep == 1)
    {
        <!-- Step 1: Select Workout Types -->
        <div class="card mb-4">
            <div class="card-body">
                <h2>Step 1: Select 4 Workout Types</h2>
                <p>Choose the exercises for today's workout for <strong>@selectedGroupName</strong></p>
                
                <!-- Navigation breadcrumb -->
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><NavLink href="/">Home</NavLink></li>
                        <li class="breadcrumb-item">@selectedGroupName</li>
                        <li class="breadcrumb-item active">Workout Types</li>
                    </ol>
                </nav>
                
                @if (availableWorkoutTypes == null || !availableWorkoutTypes.Any())
                {
                    <div class="alert alert-warning">
                        No workout types available. Please create workout types first.
                    </div>
                }
                else
                {
                    <div class="workout-types-grid">
                        @foreach (var workoutType in availableWorkoutTypes)
                        {
                            var isSelected = selectedWorkoutTypes.Contains(workoutType);
                            var buttonClass = isSelected ? "btn btn-success btn-lg workout-type-btn selected" : "btn btn-secondary btn-lg workout-type-btn";
                            
                            <button class="@buttonClass" 
                                    @onclick="() => ToggleWorkoutType(workoutType)"
                                    disabled="@(!isSelected && selectedWorkoutTypes.Count >= 4)">
                                @if (isSelected)
                                {
                                    <span class="checkmark">‚úì </span>
                                }
                                <strong>@workoutType.Name</strong>
                                @if (!string.IsNullOrEmpty(workoutType.Description))
                                {
                                    <br/><small>@workoutType.Description</small>
                                }
                            </button>
                        }
                    </div>
                    
                    <div class="mt-4">
                        <p>Selected: @selectedWorkoutTypes.Count / 4</p>
                        <button class="btn btn-secondary btn-lg me-2" @onclick="BackToHome">
                            ‚Üê Back to Home
                        </button>
                        <button class="btn btn-primary btn-lg" 
                                @onclick="NextToParticipants"
                                disabled="@(selectedWorkoutTypes.Count != 4)">
                            Next: Select Participants
                        </button>
                    </div>
                }
            </div>
        </div>
    }
    else if (currentStep == 2)
    {
        <!-- Step 2: Select Participants -->
        <div class="card mb-4">
            <div class="card-body">
                <h2>Step 2: Select Participants</h2>
                <p>Who's working out today from <strong>@selectedGroupName</strong>?</p>
                
                <!-- Navigation breadcrumb -->
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><NavLink href="/">Home</NavLink></li>
                        <li class="breadcrumb-item">@selectedGroupName</li>
                        <li class="breadcrumb-item"><a href="#" @onclick="BackToWorkoutTypes" @onclick:preventDefault="true">Workout Types</a></li>
                        <li class="breadcrumb-item active">Participants</li>
                    </ol>
                </nav>
                
                @if (groupMembers == null || !groupMembers.Any())
                {
                    <div class="alert alert-warning">
                        No members found in this group. Please invite members first.
                    </div>
                }
                 else
                 {
                     <div class="mb-3">
                         <button class="btn btn-outline-primary me-2" @onclick="SelectAllParticipants">
                             Select All
                         </button>
                         <button class="btn btn-outline-secondary" @onclick="ClearAllParticipants">
                             Clear All
                         </button>
                     </div>
                     <div class="participants-grid">
                         @foreach (var user in groupMembers)
                         {
                             var isSelected = selectedParticipants.Contains(user);
                             var buttonClass = isSelected ? "btn btn-success btn-lg participant-btn selected" : "btn btn-outline-secondary btn-lg participant-btn";
                             
                             <button class="@buttonClass" @onclick="() => ToggleParticipant(user)">
                                 @if (isSelected)
                                 {
                                     <span class="checkmark">‚úì </span>
                                 }
                                 @user.Username
                                 <br/>
                                 <small>@user.Email</small>
                             </button>
                         }
                     </div>
                     
                     <div class="mt-4">
                         <p>Selected: @selectedParticipants.Count participants</p>
                         <button class="btn btn-secondary btn-lg me-2" @onclick="BackToWorkoutTypes">
                             ‚Üê Back
                         </button>
                         <button class="btn btn-primary btn-lg" 
                                 @onclick="NextToConfirm"
                                 disabled="@(selectedParticipants.Count == 0)">
                             Next: Review & Start
                         </button>
                     </div>
                 }
            </div>
        </div>
    }
    else if (currentStep == 3)
    {
        <!-- Step 3: Review and Confirm -->
        <div class="card mb-4">
            <div class="card-body">
                <h2>Review & Start Workout</h2>
                <p>Ready to start the workout for <strong>@selectedGroupName</strong>?</p>
                
                <!-- Workout Summary -->
                <div class="workout-summary">
                    <div class="summary-section">
                        <h3>üìã Workout Types (4 Stations)</h3>
                        <div class="summary-items">
                            @for (int i = 0; i < selectedWorkoutTypes.Count; i++)
                            {
                                <div class="summary-item">
                                    <span class="station-number">Station @(i + 1)</span>
                                    <span class="workout-name">@selectedWorkoutTypes[i].Name</span>
                                </div>
                            }
                        </div>
                    </div>
                    
                    <div class="summary-section">
                        <h3>üë• Participants (@selectedParticipants.Count)</h3>
                        <div class="summary-items">
                            @foreach (var participant in selectedParticipants)
                            {
                                <div class="summary-item">
                                    <span class="participant-name">@participant.Username</span>
                                </div>
                            }
                        </div>
                    </div>
                    
                    <div class="summary-section">
                        <h3>‚è±Ô∏è Workout Format</h3>
                        <div class="workout-format">
                            <div class="format-description">
                                <strong>3 Rounds</strong> √ó <strong>4 Stations</strong> = <strong>12 Total Intervals</strong>
                            </div>
                            <div class="interval-breakdown">
                                <div class="interval-item">
                                    <span class="interval-time">10s</span>
                                    <span class="interval-name">Get Ready</span>
                                </div>
                                <div class="interval-separator">+</div>
                                <div class="interval-item">
                                    <span class="interval-time">60s</span>
                                    <span class="interval-name">Work</span>
                                </div>
                                <div class="interval-separator">+</div>
                                <div class="interval-item">
                                    <span class="interval-time">15s</span>
                                    <span class="interval-name">Cooldown</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="review-actions">
                    <button class="btn btn-secondary btn-lg" @onclick="BackToParticipants">
                        ‚Üê Back
                    </button>
                    <button class="btn btn-success btn-lg btn-start-workout" 
                            @onclick="CreateAndStartWorkout"
                            disabled="@creating">
                        @(creating ? "CREATING..." : "üî• START WORKOUT! üî•")
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private int currentStep = 1;
    private bool loading = true;
    private bool creating = false;
    private string? error;
    private UserDto? currentUser;
    private Guid? selectedGroupId;
    private string selectedGroupName = "";

    private List<WorkoutTypeDto> availableWorkoutTypes = new();
    private List<WorkoutTypeDto> selectedWorkoutTypes = new();
    
    private List<UserDto> groupMembers = new();
    private List<UserDto> selectedParticipants = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentUser();
        await InitializeGroupSelection();
        await LoadWorkoutTypes();
        loading = false;
    }

    private Task InitializeGroupSelection()
    {
        // Starting a workout must always begin with an explicit group choice.
        selectedGroupId = null;
        selectedGroupName = string.Empty;
        currentStep = 1;
        return Task.CompletedTask;
    }

    private async Task SetSelectedGroupAsync(Guid groupId)
    {
        selectedGroupId = groupId;

        var userGroups = await UserContext.GetUserGroupsAsync();
        var selectedGroup = userGroups.FirstOrDefault(g => g.Id == groupId);
        selectedGroupName = selectedGroup?.Name ?? "Unknown Group";
    }

    private async Task OnGroupChanged(Guid? groupId)
    {
        if (!groupId.HasValue)
        {
            selectedGroupId = null;
            selectedGroupName = string.Empty;
            return;
        }

        await SetSelectedGroupAsync(groupId.Value);
        currentStep = 1;

        // Reset any previous selections when switching groups
        selectedWorkoutTypes.Clear();
        selectedParticipants.Clear();
        groupMembers.Clear();
    }

    private Task OnGroupSelected(GroupDto? group)
    {
        // Kept for compatibility with GroupSelector; selection is handled in OnGroupChanged.
        return Task.CompletedTask;
    }

    private async Task LoadCurrentUser()
    {
        try
        {
            currentUser = await UserContext.GetCurrentUserAsync();
        }
        catch (Exception ex)
        {
            error = $"Failed to load user: {ex.Message}";
        }
    }

    private async Task LoadWorkoutTypes()
    {
        try
        {
            var workoutTypesResponse = await Http.GetFromJsonAsync<List<WorkoutTypeDto>>("/api/workout-types");
            availableWorkoutTypes = workoutTypesResponse ?? new();
        }
        catch (Exception ex)
        {
            error = $"Failed to load workout types: {ex.Message}";
        }
    }

    private void ToggleWorkoutType(WorkoutTypeDto workoutType)
    {
        if (selectedWorkoutTypes.Contains(workoutType))
        {
            selectedWorkoutTypes.Remove(workoutType);
        }
        else if (selectedWorkoutTypes.Count < 4)
        {
            selectedWorkoutTypes.Add(workoutType);
        }
    }

    private async Task NextToParticipants()
    {
        if (selectedGroupId.HasValue)
        {
            try
            {
                // Load group members when moving to participants step
                groupMembers = await UserContext.GetGroupMembersAsync(selectedGroupId.Value);
            }
            catch (Exception ex)
            {
                error = $"Failed to load group members: {ex.Message}";
            }
        }
        currentStep = 2;
    }

    private void BackToWorkoutTypes()
    {
        currentStep = 1;
    }

    private void BackToHome()
    {
        Navigation.NavigateTo("/");
    }

    private void ToggleParticipant(UserDto user)
    {
        if (selectedParticipants.Contains(user))
        {
            selectedParticipants.Remove(user);
        }
        else
        {
            selectedParticipants.Add(user);
        }
    }

    private void SelectAllParticipants()
    {
        selectedParticipants = new List<UserDto>(groupMembers);
    }

    private void ClearAllParticipants()
    {
        selectedParticipants.Clear();
    }

    private void NextToConfirm()
    {
        currentStep = 3;
    }

    private void BackToParticipants()
    {
        currentStep = 2;
    }

    private async Task CreateAndStartWorkout()
    {
        if (!selectedGroupId.HasValue || currentUser == null)
        {
            error = "Missing group or user context";
            return;
        }

        creating = true;
        error = null;

        try
        {
            // 1. Create workout session with proper user context
            var createSessionCommand = new
            {
                GroupId = selectedGroupId.Value,
                CreatorId = currentUser.Id,
                SessionDate = DateTime.UtcNow
            };

            var sessionResponse = await Http.PostAsJsonAsync("/api/workout-sessions", createSessionCommand);
            if (!sessionResponse.IsSuccessStatusCode)
            {
                var errorContent = await sessionResponse.Content.ReadAsStringAsync();
                error = $"Failed to create workout session: {sessionResponse.StatusCode} - {errorContent}";
                creating = false;
                return;
            }

            var session = await sessionResponse.Content.ReadFromJsonAsync<WorkoutSessionDto>();
            if (session == null)
            {
                error = "Failed to parse session response";
                creating = false;
                return;
            }

            // 2. Add workout types to session (4 stations)
            for (int i = 0; i < selectedWorkoutTypes.Count; i++)
            {
                var addWorkoutTypeCommand = new
                {
                    WorkoutSessionId = session.Id,
                    WorkoutTypeId = selectedWorkoutTypes[i].Id,
                    StationIndex = i + 1
                };

                var wtResponse = await Http.PostAsJsonAsync("/api/workout-session-workout-types", addWorkoutTypeCommand);
                if (!wtResponse.IsSuccessStatusCode)
                {
                    error = $"Failed to add workout type {selectedWorkoutTypes[i].Name}";
                    creating = false;
                    return;
                }
            }

            // 3. Add participants to session
            for (int i = 0; i < selectedParticipants.Count; i++)
            {
                var addParticipantCommand = new
                {
                    WorkoutSessionId = session.Id,
                    UserId = selectedParticipants[i].Id,
                    ParticipantIndex = i + 1
                };

                var participantResponse = await Http.PostAsJsonAsync("/api/workout-session-participants", addParticipantCommand);
                if (!participantResponse.IsSuccessStatusCode)
                {
                    error = $"Failed to add participant {selectedParticipants[i].Username}";
                    creating = false;
                    return;
                }
            }

            // 4. Navigate to run WOD page (which will auto-start the session)
            Navigation.NavigateTo($"/run-wod/{session.Id}");
        }
        catch (Exception ex)
        {
            error = $"Error creating workout: {ex.Message}";
            creating = false;
        }
    }
}