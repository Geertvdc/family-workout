@using FamilyFitness.Blazor.Models
@implements IDisposable

@if (CompactMode && CurrentPhase == TimerPhase.Cooldown)
{
    <div class="wod-timer-compact @GetPhaseClass()">
        <div class="compact-timer-content">
            <div class="compact-phase-label">@GetPhaseLabel()</div>
            <div class="compact-time">@FormatTime(TimeRemaining)</div>
            <div class="compact-progress">Round <span class="highlight">@CurrentRound</span>/3 • Station <span class="highlight">@CurrentStation</span>/4</div>
        </div>
    </div>
}
else
{
    <div class="wod-timer @GetPhaseClass()">
        <div class="timer-display">
            <div class="phase-label">
                @GetPhaseLabel()
            </div>
            <div class="time-remaining">
                @FormatTime(TimeRemaining)
            </div>
            
            @if (CurrentPhase == TimerPhase.Work)
            {
                <div class="motivational-message">
                    @currentMotivationalMessage
                </div>
            }
            
            <div class="progress-info">
                Round <span class="highlight">@CurrentRound</span> of 3 • 
                Station <span class="highlight">@CurrentStation</span> of 4
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public TimerPhase CurrentPhase { get; set; }

    [Parameter]
    public int TimeRemaining { get; set; }

    [Parameter]
    public int CurrentRound { get; set; }

    [Parameter]
    public int CurrentStation { get; set; }

    [Parameter]
    public EventCallback OnPhaseComplete { get; set; }

    [Parameter]
    public bool CompactMode { get; set; } = false;

    private string currentMotivationalMessage = "";
    private System.Threading.Timer? messageTimer;
    private static readonly string[] motivationalMessages = new[]
    {
        "PUSH IT!",
        "DON'T STOP!",
        "YOU GOT THIS!",
        "STAY STRONG!",
        "FINISH STRONG!",
        "ALMOST THERE!",
        "KEEP MOVING!",
        "NO EXCUSES!",
        "EARN IT!",
        "BEAST MODE!",
        "ONE MORE REP!",
        "DIG DEEP!",
        "NO QUIT!",
        "MAKE IT COUNT!"
    };

    protected override void OnInitialized()
    {
        RotateMotivationalMessage();
        messageTimer = new System.Threading.Timer(_ => 
        {
            InvokeAsync(() =>
            {
                RotateMotivationalMessage();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(10), TimeSpan.FromSeconds(10));
    }

    private void RotateMotivationalMessage()
    {
        var random = new Random();
        currentMotivationalMessage = motivationalMessages[random.Next(motivationalMessages.Length)];
    }

    private string GetPhaseClass()
    {
        return CurrentPhase switch
        {
            TimerPhase.Ready => "phase-ready",
            TimerPhase.Work => "phase-work",
            TimerPhase.Cooldown => "phase-cooldown",
            _ => ""
        };
    }

    private string GetPhaseLabel()
    {
        return CurrentPhase switch
        {
            TimerPhase.Ready => "GET READY!",
            TimerPhase.Work => "WORK!",
            TimerPhase.Cooldown => "COOLDOWN",
            _ => ""
        };
    }

    private string FormatTime(int seconds)
    {
        var minutes = seconds / 60;
        var secs = seconds % 60;
        return $"{minutes:D2}:{secs:D2}";
    }

    public void Dispose()
    {
        messageTimer?.Dispose();
    }
}
