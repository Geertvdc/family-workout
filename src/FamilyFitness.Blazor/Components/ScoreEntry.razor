@using FamilyFitness.Blazor.Models
@using System.Net.Http.Json
@inject HttpClient Http

<div class="score-entry">
    @if (error != null)
    {
        <div class="alert alert-danger">@error</div>
    }

    @if (success)
    {
        <div class="alert alert-success">Scores saved!</div>
    }

    @if (Participants != null && Stations != null)
    {
        <div class="score-table">
            <div class="score-table-header">
                <div class="col-participant">PARTICIPANT</div>
                <div class="col-exercise">EXERCISE</div>
                <div class="col-score">SCORE</div>
                <div class="col-presets">QUICK</div>
            </div>
            
            @foreach (var participant in Participants.OrderBy(p => p.ParticipantIndex))
            {
                var station = GetStationForParticipant(participant);
                if (station != null)
                {
                    var scoreKey = $"{participant.ParticipantId}_{CurrentRound}_{CurrentStation}";
                    var currentScore = scores.GetValueOrDefault(scoreKey, 0);

                    <div class="score-table-row">
                        <div class="col-participant">
                            <span class="participant-name-table">@participant.UserName</span>
                        </div>
                        <div class="col-exercise">
                            <span class="exercise-name-table">@station.WorkoutTypeName</span>
                            @if (!string.IsNullOrEmpty(station.WorkoutTypeDescription))
                            {
                                <div class="exercise-description-table">@station.WorkoutTypeDescription</div>
                            }
                        </div>
                        <div class="col-score">
                            <div class="score-controls-table">
                                <button class="btn-score-table" @onclick="() => DecrementScore(scoreKey)">âˆ’</button>
                                <div class="score-display-table">@currentScore</div>
                                <button class="btn-score-table" @onclick="() => IncrementScore(scoreKey)">+</button>
                            </div>
                        </div>
                        <div class="col-presets">
                            <div class="quick-presets-table">
                                @foreach (var preset in new[] { 15, 30, 45, 60 })
                                {
                                    <button class="btn-preset-table" @onclick="() => SetScore(scoreKey, preset)">@preset</button>
                                }
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    }
</div>

@code {
    [Parameter]
    public Guid SessionId { get; set; }

    [Parameter]
    public List<ParticipantDto>? Participants { get; set; }

    [Parameter]
    public List<StationDto>? Stations { get; set; }

    [Parameter]
    public int CurrentRound { get; set; }

    [Parameter]
    public int CurrentStation { get; set; }

    [Parameter]
    public EventCallback OnScoresSaved { get; set; }

    [Parameter]
    public EventCallback<bool> OnSavingStateChanged { get; set; }

    private Dictionary<string, int> scores = new();
    private bool success = false;
    private string? error;

    private void IncrementScore(string key)
    {
        scores[key] = scores.GetValueOrDefault(key, 0) + 1;
    }

    private void DecrementScore(string key)
    {
        var current = scores.GetValueOrDefault(key, 0);
        if (current > 0)
        {
            scores[key] = current - 1;
        }
    }

    private void SetScore(string key, int value)
    {
        scores[key] = value;
    }

    public async Task SaveScoresExternal()
    {
        if (Participants == null || Stations == null)
            return;

        await OnSavingStateChanged.InvokeAsync(true);
        error = null;
        success = false;

        try
        {
            foreach (var participant in Participants)
            {
                var station = GetStationForParticipant(participant);
                if (station != null)
                {
                    var scoreKey = $"{participant.ParticipantId}_{CurrentRound}_{CurrentStation}";
                    var score = scores.GetValueOrDefault(scoreKey, 0);

                    var command = new
                    {
                        ParticipantId = participant.ParticipantId,
                        RoundNumber = CurrentRound,
                        StationIndex = CurrentStation,
                        WorkoutTypeId = station.WorkoutTypeId,
                        Score = score,
                        Weight = (decimal?)null
                    };

                    var response = await Http.PostAsJsonAsync("/api/workout-interval-scores", command);
                    if (!response.IsSuccessStatusCode)
                    {
                        error = $"Failed to save score for {participant.UserName}";
                        await OnSavingStateChanged.InvokeAsync(false);
                        return;
                    }
                }
            }

            success = true;
            await OnScoresSaved.InvokeAsync();
        }
        catch (Exception ex)
        {
            error = $"Error saving scores: {ex.Message}";
        }
        finally
        {
            await OnSavingStateChanged.InvokeAsync(false);
        }
    }

    private StationDto? GetStationForParticipant(ParticipantDto participant)
    {
        if (Stations == null || Participants == null) return null;

        var participantCount = Participants.Count;
        var stationCount = Stations.Count;

        var baseStationIndex = ((participant.ParticipantIndex - 1) % stationCount) + 1;
        var intervalsCompleted = ((CurrentRound - 1) * stationCount) + (CurrentStation - 1);
        var currentStationIndex = ((baseStationIndex - 1 + intervalsCompleted) % stationCount) + 1;

        return Stations.FirstOrDefault(s => s.StationIndex == currentStationIndex);
    }
}
